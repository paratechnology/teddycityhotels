<ion-header class="premium-header">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button (click)="dismiss()" color="medium">
        <ion-icon name="close" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
    
    <ion-title>
      <div class="header-title-stack">
        <span>Master Schedule</span>
        <span>{{ currentDate() | date: 'MMMM yyyy' }}</span>
      </div>
    </ion-title>

    <ion-buttons slot="end">
      <ion-item lines="none" class="toggle-item">
        <ion-toggle [checked]="showWeekends()" (ionChange)="toggleWeekends($event)">
          Wknds
        </ion-toggle>
      </ion-item>
    </ion-buttons>
  </ion-toolbar>

  <ion-toolbar class="date-nav-toolbar">
    <ion-buttons slot="start">
      <ion-button fill="clear" (click)="changeWeek(-1)">
        <ion-icon name="chevron-back" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
    
    <div class="date-title">
      Week of {{ currentWeekStartDate() | date: 'MMM d' }}
    </div>
    
    <ion-buttons slot="end">
      <ion-button fill="clear" (click)="changeWeek(1)">
        <ion-icon name="chevron-forward" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="master-schedule-content">
  <div class="layout-container">
    
    <div class="sidebar" id="ms-sidebar">
      <div class="sidebar-section">
        <ion-searchbar placeholder="Filter staff..." (ionInput)="handleSearch($event)" class="custom-searchbar"></ion-searchbar>
        
        <div class="section-label">Staff Members</div>
        <ion-list class="dense-list" [class.highlight-mode]="!!selectedEventForHighlight()">
          <ion-item 
            *ngFor="let user of filteredStaff()"
            button 
            lines="none"
            class="user-item"            
            (click)="handleStaffClick(user)"
            [class.active-filter]="selectedStaffForFilter()?.id === user.id"
            [class.highlighted]="isUserAttendee(selectedEventForHighlight(), user)"
            [class.dimmed]="isUserDimmed(selectedEventForHighlight(), user)">
            
            <div class="user-row">
              <span class="user-name">{{ user.fullname }}</span>
              <ion-icon *ngIf="didUserAttendLastEvent(user)" name="time-outline" class="recent-icon" color="medium" title="Last Attended"></ion-icon>
            </div>
          </ion-item>
        </ion-list>
      </div>
    </div>

    <div class="schedule-grid-wrapper" id="ms-grid">
      
      <div class="day-selector-header">
        <div *ngFor="let day of weekDays()" 
             class="day-tab" 
             [class.active-day]="day.toDateString() === currentDate().toDateString()"
             (click)="selectDay(day)">
          <div class="day-name">{{ day | date: 'EEE' }}</div>
          <div class="day-date">{{ day | date: 'd' }}</div>
        </div>
      </div>

      <div class="daily-focus-grid">
        <div class="grid-header-row">
          <div class="time-header">Time</div>
          <div class="events-header">Events for {{ currentDate() | date:'EEEE, MMM d' }}</div>
        </div>

        <div class="grid-body">
          <ng-container *ngFor="let time of timeSlots()">
            <div class="grid-row">
              <div class="time-col" (click)="addDraftEvent(currentDate(), time)">
                <span class="time-label">{{ time }}</span>
                <ion-icon name="add-circle-outline" class="add-icon"></ion-icon>
              </div>
              
              <div class="events-col">
                <div *ngFor="let event of getEventsForSlot(time)" 
                     class="event-card" 
                     [class.draft]="isDraftEvent(event)" 
                     [class.active]="selectedEventForHighlight() === event"
                     (click)="toggleEventHighlight(event)">
                  
                  <div class="card-header-row">
                    <span class="event-title">{{ event.title }}</span>
                    <ion-button fill="clear" size="small" class="edit-btn" (click)="editEvent(event, $event)">
                      <ion-icon slot="icon-only" name="create-outline"></ion-icon>
                    </ion-button>
                  </div>

                  <div class="chip-container">
                    <div *ngFor="let attendee of event.attendees" 
                         class="sovereign-chip"
                         [class.dimmed]="!isUserAttendee(event, { id: attendee.id, fullname: attendee.fullname })">
                      <div class="chip-avatar">{{ getInitials(attendee.fullname) }}</div>
                      <span class="chip-label">{{ attendee.fullname }}</span>
                    </div>
                  </div>

                </div>
              </div>
            </div>
          </ng-container>
        </div>
      </div>

    </div>
  </div>
</ion-content>

<ion-footer class="master-footer" id="ms-footer">
  <ion-toolbar>
    <ion-button 
      slot="end" 
      color="secondary"
      (click)="saveAll()" 
      [disabled]="isSaving() || draftEvents().length === 0">
      <ion-spinner *ngIf="isSaving()" slot="start"></ion-spinner>
      <ion-icon *ngIf="!isSaving()" name="save-outline" slot="start"></ion-icon>
      <span *ngIf="!isSaving()">Save {{ draftEvents().length }} Changes</span>
    </ion-button>
  </ion-toolbar>
</ion-footer>