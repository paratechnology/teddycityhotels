<ion-header>
  <ion-toolbar>
    <ion-title>New Invoice</ion-title>
    <ion-buttons slot="start">
      @if (currentStep() === 'review_items') {
      <ion-button (click)="goBackToMatterSelect()">Back</ion-button>
      } @else {
      <ion-button (click)="cancel()">Cancel</ion-button>
      }
    </ion-buttons>
    <ion-buttons slot="end">
      @if (currentStep() === 'review_items') {
      <ion-button (click)="createInvoice()" [strong]="true" [disabled]="isSubmitting() || selectedItemIds().size === 0">
        <ion-spinner *ngIf="isSubmitting()" name="crescent"></ion-spinner>
        <span *ngIf="!isSubmitting()">Create Invoice</span>
      </ion-button>
      }
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div [ngSwitch]="currentStep()">

    <!-- Step 1: Select Matter -->
    <div *ngSwitchCase="'select_matter'" class="step-container">
      <ion-list [inset]="true">
        <ion-item button="true" detail="false" (click)="openMatterSelect()">
          <ion-label>
            <h2>Select a Matter</h2>
            <p>Choose the matter you want to generate an invoice for.</p>
          </ion-label>
          <ion-icon name="chevron-forward" slot="end" color="medium"></ion-icon>
        </ion-item>
      </ion-list>
    </div>

    <!-- Step 2: Review Items -->
    <div *ngSwitchCase="'review_items'">
      @if (isLoadingItems()) {
      <div class="centered-container"><ion-spinner></ion-spinner></div>
      } @else if (selectedMatter()) {
      <ion-list [inset]="true">
        <ion-list-header>
          <ion-label>
            <h1>{{ selectedMatter()!.title }}</h1>
            <p>Select items to include in the invoice.</p>
          </ion-label>
        </ion-list-header>
        @for (item of unbilledItems(); track item.id) {
        <ion-item>
          <ion-checkbox slot="start" [checked]="selectedItemIds().has(item.id)"
            (ionChange)="toggleItemSelection(item.id, $event.detail.checked)"></ion-checkbox>
          <ion-label>
            <h2>{{ item.description }}</h2>
            <p>{{ item.date | date:'mediumDate' }}</p>
          </ion-label>
          <ion-note slot="end">₦{{ item.amount.toLocaleString() }}</ion-note>
        </ion-item>
        } @empty {
        <ion-item lines="none">
          <ion-label class="ion-text-center ion-padding">No unbilled items found for this matter.</ion-label>
        </ion-item>
        }
        <ion-item-divider></ion-item-divider>
        <ion-item lines="none">
          <ion-label slot="end">
            <p>Subtotal</p>
            <h2><strong>₦{{ invoiceSummary().subtotal.toLocaleString() }}</strong></h2>
          </ion-label>
        </ion-item>
      </ion-list>
      }
    </div>
  </div>
</ion-content>